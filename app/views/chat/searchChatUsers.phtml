<?php

/**
 * 
 * @param type $rootPath
 * @param type $username
 * @param type $author
 * @return string
 */
function getImage ($rootPath, $username, $author)
{
    if ( file_exists ($rootPath . '/blab/public/uploads/profile/' . $username . '.jpg') )
    {
        $image = '<img style="width:25px; margin-right: 8px; float:left;" title="' . $author . '" alt="image" class="img-circle img-responsive" src="/blab/public/uploads/profile/' . $username . '.jpg">';
    }
    else
    {
        $image = '<img style="width:25px; margin-right: 8px; float:left;" alt="image" class="img-circle img-responsive" src="/blab/public/img/avatar.gif">';
    }

    return $image;
}

/**
 * 
 * @param Message $objMessage
 * @return string
 */
function getFrom (Message $objMessage)
{
    if ( trim ($objMessage->getRecipient ()) !== "" )
    {
        $from = (int) $objMessage->getRecipient () === (int) $_SESSION['user']['user_id'] ? $objMessage->getAuthor () : 'You';
    }
    else
    {
        $from = '';
    }

    return $from;
}

/**
 * 
 * @param type $lastLogin
 * @return string
 */
function getActiveLabel ($lastLogin)
{
    $activeLabel = 'chat-not-active-user';

    if ( trim ($lastLogin) !== "" )
    {
        $dbdate = strtotime ($lastLogin);
        if ( time () - $dbdate <= 15 * 60 )
        {
            $activeLabel = 'chat-active-user';
        }
        else
        {
            $activeLabel = 'chat-not-active-user';
        }
    }
    else
    {
        $activeLabel = 'chat-not-active-user';
    }

    return $activeLabel;
}

/**
 * 
 * @param type $lastLogin
 * @return string
 */
function getOnlineLabel ($lastLogin)
{
    $onlineLabel = 'text-danger';

    if ( trim ($lastLogin) !== "" )
    {
        $dbdate = strtotime ($lastLogin);
        if ( time () - $dbdate <= 15 * 60 )
        {
            $onlineLabel = 'text-navy';
        }
        else
        {
            $onlineLabel = 'text-danger';
        }
    }
    else
    {
        $onlineLabel = 'text-danger';
    }

    return $onlineLabel;
}
?>

<div class="col-lg-12" style="width:100%; font-size: 14px; margin-bottom: 12px;">
    <a href="#" class="showActiveUsers btn btn-success">Active</a>
    <a href="#" class="showGroups btn btn-warning">Groups</a>
    <a href="#" class="showDiscover btn btn-danger">Discover</a>
    <a href="#" class="showAllChat btn btn-primary">All</a>
</div>

<div class="usersDiv">
    <?php
    echo '<h5>Friends</h5>';

    foreach ($arrMessages['messages'] as $objMessage):

        $from = getFrom ($objMessage);

        $image = getImage ($rootPath, $objMessage->getUsername (), $objMessage->getAuthor ());

        $onlineLabel = getOnlineLabel ($objMessage->getLastLogin ());
        $activeLabel = getActiveLabel ($objMessage->getLastLogin ());
        $displaySearch = 'block';

        if ( !empty ($searchText) )
        {
            $displaySearch = trim ($searchText) !== "" && (
                    strpos ($objMessage->getAuthor (), $searchText) ||
                    strpos ($objMessage->getUsername (), $searchText) !== false) ? 'block' : 'none';
        }
        
        if ( $objMessage->getUsername () !== $_SESSION['user']['username'] ):
            ?>
            <li style="width:100%; border-bottom: 1px dotted #CCC; min-height: 32px; float: left; display: <?= $displaySearch ?>">
                <a class="show-chat single <?= $activeLabel ?>" groupname="" groupid="" username="<?= $objMessage->getUsername () ?>" fullname="<?= str_replace (" ", "|", $objMessage->getAuthor ()) ?>" session-user="<?= $_SESSION['user']['username'] ?>" user-id="<?= $objMessage->getUserId () ?>" href="#"> 

                    <div class="col-lg-9">
                        <?= $image ?>

                        <?= $objMessage->getAuthor () ?> <i class="fa fa-circle <?= $onlineLabel ?>"></i> 

                        <br>
                        <?= $from . ' ' . substr ($objMessage->getMessage (), 0, 20) ?>
                    </div>

                    <div class="col-lg-3">
                        <?= date ("d F", strtotime ($objMessage->getDate ())) ?>

                    </div>
                </a>
            </li>

            <?php
        endif;
    endforeach;

    foreach ($arrMessages['users'] as $objMessage):

        $image = getImage ($rootPath, $objMessage->getUsername (), $objMessage->getFirstName () . ' ' . $objMessage->getLastName ());

        $onlineLabel = getOnlineLabel ($objMessage->getLastLogin ());
        $activeLabel = getActiveLabel ($objMessage->getLastLogin ());
        $displaySearch = 'block';

        if ( trim($searchText) !== "" )
        {
            $displaySearch = !empty ($searchText) && (
                    strpos ($objMessage->getFirstName () . ' ' . $objMessage->getLastName (), $searchText) ||
                    strpos ($objMessage->getUsername (), $searchText) !== false) ? 'block' : 'none';
        }
        
        if ( $objMessage->getUsername () !== $_SESSION['user']['username'] ):
            ?>
            <li style="width:100%; border-bottom: 1px dotted #CCC; min-height: 32px; float: left; display: <?= $displaySearch ?>">
                <a class="show-chat single <?= $activeLabel ?>" groupname="" groupid="" username="<?= $objMessage->getUsername () ?>" fullname="<?= $objMessage->getFirstName () . '|' . $objMessage->getLastName () ?>" session-user="<?= $_SESSION['user']['username'] ?>" user-id="<?= $objMessage->getId () ?>" href="#"> 

                    <div class="col-lg-9">
                        <?= $image ?>

                        <?= $objMessage->getFirstName () . ' ' . $objMessage->getLastName () ?> <i class="fa fa-circle <?= $onlineLabel ?>"></i>  <br>

                    </div>

                    <div class="col-lg-3">


                    </div>
                </a>
            </li>

            <?php
        endif;
    endforeach;

    echo '</div>';

    echo '<div class="groupsDiv" style="width:100%;">';

    if ( isset ($arrChatGroups) && !empty ($arrChatGroups) ):

        echo '<h5>Groups</h5>';

        foreach ($arrChatGroups as $arrChatGroup):
            ?>
            <li>
                <a class="show-chat group" groupname="<?= $arrChatGroup['name'] ?>" groupid="<?= $arrChatGroup['group_id'] ?>" username="<?= $arrChatGroup['users'] ?>" fullname="<?= $arrChatGroup['fullname'] ?>" session-user="<?= $_SESSION['user']['username'] ?>" href="#"> 
                    <i class="fa fa-circle text-danger"></i> <?= $arrChatGroup['name'] ?> </a></li>

            <?php
        endforeach;
    endif;

    echo '</div>';

    echo '<div class="discover" style="width:100%; display:none;">';
    $this->partial ("chat/discovery", ["arrPages" => $arrPages, "arrPageCategories" => $arrPageCategories]);


    echo '</div>';
    ?>